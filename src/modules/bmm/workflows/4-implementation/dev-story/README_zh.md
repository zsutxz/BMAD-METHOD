# 开发故事工作流

dev-story工作流是v6及时上下文方法交付其主要价值的地方，使开发者（DEV）代理能够通过直接注入其上下文的专家级指导来实施故事。此工作流专门由DEV代理运行，并在一个由SM通过create-story准备并通过story-context增强的单个故事上操作。DEV加载故事规范和动态生成的故事上下文XML，然后在需求和领域专业知识的综合知识指导下进行实施。

工作流在两个关键输入下运行：故事文件（由SM的create-story创建）包含验收标准、任务和需求；以及story-context XML（由SM的story-context生成）为故事的技术需求提供及时的专家知识注入。这种双重输入方法确保开发人员拥有成功实施所需的"内容"（来自故事）和"方法"（来自上下文）。工作流按顺序迭代任务，实施代码、编写测试并更新故事文档的允许部分，直到所有任务完成。

v6流程的一个关键方面是dev-story可以为同一个故事运行多次。最初用于实施故事，在review-story识别需要纠正的问题后可以再次运行。工作流智能地从未完成的任务恢复，使其非常适合初始实施和审查后修复。DEV代理在故事文件中可以修改的内容上保持严格边界——只有任务/子任务复选框、开发代理记录、文件列表、更改日志和状态可以更新，保持故事的需求完整性。

## 使用方法

```bash
# 开发人员使用注入的上下文实施故事
bmad dev *develop

# 或者返回修复审查问题
bmad dev *develop  # 将从未完成的任务恢复
```

DEV在以下情况下运行此工作流：

- 在SM完成create-story和story-context之后
- 当故事状态为"草稿"或"已批准"（准备开发）时
- 在review-story识别需要修复的问题之后
- 恢复部分完成故事的工作

## 输入

**必需文件：**

- **故事文档**（`{story_dir}/story-{epic}.{story}.md`）：完整规范，包括：
  - 用户故事陈述
  - 验收标准（开发期间不可变）
  - 任务和子任务（实施期间可勾选）
  - 开发说明部分（用于上下文和指导）
  - 状态字段（草稿 → 进行中 → 准备审查）

- **故事上下文XML**（`{story_dir}/story-{epic}.{story}-context.xml`）：领域专业知识，包括：
  - 技术模式和最佳实践
  - 陷阱和常见问题
  - 测试策略
  - 相关代码引用
  - 架构约束

**配置：**

- `dev_story_location`：包含故事文件的目录（来自bmm/config.yaml）
- `story_selection_limit`：要显示的最近故事数量（默认：10）
- `run_tests_command`：测试命令（默认：自动检测）
- `strict`：是否在测试失败时停止（默认：true）

## 输出

**代码实施：**

- 满足验收标准的生产代码
- 适当的单元、集成和E2E测试
- 文档更新
- 如需要，迁移脚本

**故事文件更新（仅允许的部分）：**

- **任务/子任务**：随着工作进展标记完成
- **开发代理记录**：调试日志和完成说明
- **文件列表**：所有创建或修改的文件
- **更改日志**：实施更改摘要
- **状态**：完成时更新为"准备审查"

**验证：**

- 所有测试通过（现有 + 新建）
- 验收标准已验证
- 代码质量检查通过
- 现有功能无回归

## 关键特性

**故事上下文集成**：工作流在整个实施过程中加载并利用story-context XML，在不混乱主要对话的情况下提供专家指导。这确保遵循最佳实践，同时保持开发人员自主性。

**任务迭代**：一次实施一个任务，在移动到下一个任务之前标记完成。这种细化方法实现进度跟踪和在中断或审查反馈后的干净恢复。

**严格文件边界**：只有故事文件的特定部分可以修改，保持需求完整性。故事的验收标准、主要描述和其他规划部分在开发期间保持不可变。

**测试驱动方法**：对于每个任务，工作流强调在实施之前或同时编写验证验收标准的测试，确保需求实际得到满足。

**可恢复实施**：如果在具有未完成任务的故事上再次运行工作流（例如，在review-story发现问题后），它会智能地从中断的地方恢复，而不是重新开始。

## 与v6流程的集成

dev-story工作流是v6实施周期中的步骤3：

1. SM: create-story（生成故事规范）
2. SM: story-context（添加JIT技术专业知识）
3. **DEV: dev-story** ← 您在这里（初始实施）
4. DEV/SR: review-story（验证完成）
5. 如果发现问题：**DEV: dev-story** ← 可能返回这里进行修复
6. 史诗后：retrospective（捕获学习成果）

此工作流可能为同一故事执行多次，作为审查-修复周期的一部分。每次执行都从未完成的任务开始，使其对迭代改进高效。

## 工作流过程

### 阶段1：故事选择

- 如果提供了`story_path`：直接使用该故事
- 否则：列出来自`dev_story_location`的最近故事
- 解析故事结构并验证格式
- 加载相应的story-context XML

### 阶段2：任务实施循环

对于每个未完成的任务：

1. **计划**：在开发代理记录中记录方法
2. **实施**：按照story-context指导编写代码
3. **测试**：创建验证验收标准的测试
4. **验证**：运行测试和质量检查
5. **更新**：标记任务完成，更新文件列表

### 阶段3：完成

- 验证所有任务完成
- 运行完整测试套件
- 更新状态为"准备审查"
- 向开发代理记录添加完成说明

## 故事文件结构

工作流期望具有此结构的故事：

```markdown
# 故事 {epic}.{story}: {标题}

**状态**: 草稿|进行中|准备审查|完成
**史诗**: {epic_number}
**估计工作量**: {estimate}

## 故事

作为{角色}，我想要{行动}以便{收益}

## 验收标准

- [ ] AC1...
- [ ] AC2...

## 任务和子任务

- [ ] 任务1
  - [ ] 子任务1.1
- [ ] 任务2

## 开发说明

{来自故事创建的上下文和指导}

## 开发代理记录

### 调试日志

{开发期间添加的实施说明}

### 完成说明

{完成时添加的摘要}

## 文件列表

{创建/修改的文件}

## 更改日志

{实施摘要}
```

## 最佳实践

**首先加载上下文**：始终确保在开始时加载story-context XML。这提供了整个实施过程所需的专家指导。

**遵循任务顺序**：按列出的顺序实施任务。依赖关系通常在任务序列中结构化。

**测试每个任务**：不要等到最后才写测试。在完成每个任务时测试它以确保它满足验收标准。

**增量更新**：在每个任务完成后更新故事文件，而不是在最后批量更新。

**尊重边界**：永远不要修改验收标准或故事描述。如果它们看起来错误，那是review-story或correct-course问题，不是dev-story修复。

**使用上下文指导**：主动引用story-context以获取模式、陷阱和最佳实践。它在那里帮助您成功。

## 故障排除

**未找到故事**：确保故事存在于`dev_story_location`中并遵循命名模式`story-{epic}.{story}.md`

**缺少上下文XML**：必须先运行story-context工作流。检查`story-{epic}.{story}-context.xml`

**测试失败**：如果严格模式开启，工作流停止。在继续之前修复测试或为开发迭代设置strict=false。

**无法修改故事部分**：记住只有任务、开发代理记录、文件列表、更改日志和状态可以修改。其他部分是不可变的。

**审查后恢复**：如果review-story发现问题，当再次运行时工作流自动从未完成的任务开始。

## 相关工作流

- **create-story**：创建故事规范（由SM运行）
- **story-context**：生成上下文XML（由SM运行）
- **review-story**：验证实施（由SR/DEV运行）
- **correct-course**：处理主要问题或范围变更（由SM运行）