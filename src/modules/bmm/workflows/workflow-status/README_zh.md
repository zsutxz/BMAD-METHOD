# 工作流状态系统

BMM工作流的通用入口点 - 为任何代理回答"我现在应该做什么？"

## 概述

工作流状态系统提供：

- **智能项目初始化** - 检测现有工作并推断项目详情
- **简单状态跟踪** - 键值对实现即时解析
- **智能路由** - 基于当前状态建议下一步操作
- **模块化工作流路径** - 每种项目类型/级别都有自己的清晰定义

## 架构

### 核心组件

```
workflow-status/
├── workflow.yaml              # 主配置
├── instructions.md            # 状态检查器（99行）
├── workflow-status-template.md # 清晰的键值模板
├── project-levels.yaml        # 规模定义的事实来源
└── paths/                     # 模块化工作流定义
    ├── greenfield-level-0.yaml 到 level-4.yaml
    ├── brownfield-level-0.yaml 到 level-4.yaml
    └── game-design.yaml
```

### 相关工作流

```
workflow-init/
├── workflow.yaml              # 初始化配置
└── instructions.md            # 智能设置（182行）
```

## 工作原理

### 对于新项目

1. 用户运行`workflow-status`
2. 系统未找到状态文件
3. 引导到`workflow-init`
4. 初始化工作流：
   - 扫描现有工作（PRD、代码等）
   - 根据发现的内容推断项目详情
   - 询问最少问题（名称 + 描述）
   - 一次性确认理解
   - 创建带有工作流路径的状态文件

### 对于现有项目

1. 用户运行`workflow-status`
2. 系统读取状态文件
3. 显示当前状态和选项：
   - 继续进行中的工作
   - 下一个必需步骤
   - 可用的可选工作流
4. 用户选择操作

## 状态文件格式

简单的键值对实现即时解析：

```markdown
PROJECT_NAME: MyProject
PROJECT_TYPE: software
PROJECT_LEVEL: 2
FIELD_TYPE: greenfield
CURRENT_PHASE: 2-Planning
CURRENT_WORKFLOW: prd
TODO_STORY: story-1.2.md
IN_PROGRESS_STORY: story-1.1.md
NEXT_ACTION: Continue PRD
NEXT_COMMAND: prd
NEXT_AGENT: pm
```

任何代理都可以立即grep他们需要的内容：

- SM: `grep 'TODO_STORY:' status.md`
- DEV: `grep 'IN_PROGRESS_STORY:' status.md`
- 任何代理: `grep 'NEXT_ACTION:' status.md`

## 项目级别

事实来源：`/src/modules/bmm/README.md` 第77-85行

- **级别0**：单个原子更改（1个故事）
- **级别1**：小型功能（1-10个故事）
- **级别2**：中型项目（5-15个故事）
- **级别3**：复杂系统（12-40个故事）
- **级别4**：企业规模（40+个故事）

## 工作流路径

每个组合都有自己的文件：

- `greenfield-level-X.yaml` - 每个级别的新项目
- `brownfield-level-X.yaml` - 每个级别的现有代码库
- `game-design.yaml` - 游戏项目（所有级别）

优势：

- 只加载需要的内容（60行 vs 750+行）
- 易于维护单个路径
- 清晰的关注点分离

## 智能检测

初始化工作流智能检测：

**项目类型：**

- 找到GDD → 游戏
- 否则 → 软件

**项目级别：**

- 读取PRD史诗/故事计数
- 分析范围描述
- 做出有根据的猜测

**字段类型：**

- 找到源代码 → 现有项目
- 只有规划文档 → 全新项目
- 检查git历史记录年龄

**文档状态：**

- 找到index.md → 之前未文档化
- 有好的README → 已文档化
- 缺少文档 → 需要文档化

## 使用示例

### 任何代理检查状态

```
代理：workflow-status
结果："TODO: story-1.2.md, Next: create-story"
```

### 新项目设置

```
代理：workflow-status
系统："未找到状态。运行workflow-init"
代理：workflow-init
系统："告诉我关于你的项目"
用户："构建一个带有用户管理的仪表板"
系统："级别2全新软件项目。正确吗？"
用户："是的"
系统："状态已创建！下一步：pm代理，运行prd"
```

### 智能推断

```
系统找到：prd-dashboard.md，包含3个史诗
系统找到：package.json，src/目录
系统推断：级别2现有软件
用户确认或纠正
```

## 设计理念

**减少结构，增加智能**

而不是复杂的if/else逻辑：

- 信任LLM分析和推断
- 使用自然语言进行纠正
- 保持菜单简单和上下文相关
- 让智能从模型中涌现

**结果：**一个像与智能助手对话而不是填写表格的工作流系统。

## 实现细节

### workflow-init（6个步骤）

1. **扫描现有工作** - 检查文档、代码、git历史
2. **确认发现** - 显示检测到的内容（如果有）
3. **收集信息** - 名称、描述、确认类型/级别/字段
4. **加载路径文件** - 选择适当的工作流定义
5. **生成工作流** - 从路径文件构建
6. **创建状态文件** - 保存并显示下一步

### workflow-status（4个步骤）

1. **检查状态文件** - 如果缺失则引导到初始化
2. **解析状态** - 提取键值对
3. **显示选项** - 显示当前、必需、可选的选项
4. **处理选择** - 执行用户的选择

## 最佳实践

1. **让AI猜测** - 通常是对的，需要时用户会纠正
2. **一次对话** - 在初始化的第3步获取所有信息
3. **简单解析** - 键值对，而不是复杂结构
4. **模块化路径** - 每个场景在自己的文件中
5. **信任智能** - LLM比规则更好地理解上下文

## 集成

其他工作流读取状态来协调：

- `create-story`读取TODO_STORY
- `dev-story`读取IN_PROGRESS_STORY
- 任何工作流都可以检查CURRENT_PHASE
- 所有代理都可以问"我应该做什么？"

状态文件是项目状态的单一事实来源，也是保持所有代理同步的枢纽。

## 优势

✅ **智能检测** - 从现有工作推断而不是询问所有事情
✅ **最少问题** - 大多数情况下只需要名称和描述
✅ **清晰状态** - 简单键值对实现即时解析
✅ **模块化路径** - 60行文件而不是750+行单体文件
✅ **自然语言** - "告诉我关于你的项目"而不是"选择1-12"
✅ **智能菜单** - 只显示相关选项
✅ **快速解析** - 使用grep而不是复杂逻辑
✅ **易于维护** - 更改一个级别而不影响其他级别

## 未来增强

- 可视化进度指示器
- 时间跟踪和估算
- 多项目支持
- 团队同步

---

**此工作流是BMad方法的前门。从这里开始了解下一步该做什么。**