# 决策架构工作流程 - 技术参考

**模块：** BMM（BMAD 方法模块）
**类型：** 解决方案设计工作流程

---

## 概述

决策架构工作流程是对 BMAD 方法中架构决策制定方式的彻底重新构想。与模板驱动的文档不同，此工作流程促进智能对话，产生**以决策为中心的架构文档**，专为防止实施期间的 AI 代理冲突而优化。

---

## 核心理念

**问题**：当多个 AI 代理实施系统的不同部分时，他们会做出冲突的技术决策，导致不兼容的实施。

**解决方案**：一个"一致性合约"，预先记录所有关键技术决策，确保每个代理遵循相同的模式并使用相同的技术。

---

## 关键特性

### 1. 起始模板智能 ⭐ 新功能

- 发现相关的起始模板（create-next-app、create-t3-app 等）
- 在选择模板时考虑 UX 需求（动画、可访问性等）
- 搜索当前 CLI 选项和默认值
- 记录由起始模板做出的决策
- 围绕起始基础做出剩余的架构决策
- 第一个实施故事变成"使用起始命令初始化"

### 2. 自适应促进

- 根据用户技能水平调整对话风格（初学者/中级/专家）
- 专家获得快速、技术性的讨论
- 初学者接收教育和复杂性保护
- 每个人都产生相同的高质量输出

### 3. 动态版本验证

- 绝不信任硬编码的版本号
- 使用 WebSearch 查找当前稳定版本
- 在对话期间验证版本
- 仅记录经过验证的当前版本

### 4. 智能发现

- 没有僵化的项目类型模板
- 分析 PRD 以识别对这个项目重要的决策
- 使用决策和模式的知识库
- 扩展到无限的项目类型

### 5. 协作决策制定

- 为每个关键决策促进讨论
- 提出带有权衡取舍的选项
- 集成高级启发方法以获得创新方法
- 确保决策是连贯和兼容的

### 6. 一致性输出

- 对话期间结构化决策收集
- 从收集的决策严格生成文档
- 针对硬性要求进行验证
- 为 AI 代理消费进行优化

---

## 工作流程结构

```
步骤 0：验证工作流程并提取项目配置
步骤 0.5：验证工作流程排序
步骤 1：加载 PRD 并理解项目上下文
步骤 2：发现和评估起始模板 ⭐ 新功能
步骤 3：调整促进风格并识别剩余决策
步骤 4：促进协作决策制定（带版本验证）
步骤 5：解决横切关注点
步骤 6：定义项目结构和边界
步骤 7：设计新颖的架构模式（需要时）⭐ 新功能
步骤 8：定义实施模式以防止代理冲突
步骤 9：验证架构连贯性
步骤 10：生成决策架构文档（带初始化命令）
步骤 11：验证文档完整性
步骤 12：最终审查并更新工作流程状态
```

---

## 此工作流程中的文件

- **workflow.yaml** - 配置和元数据
- **instructions.md** - 自适应促进流程
- **decision-catalog.yaml** - 所有架构决策的知识库
- **architecture-patterns.yaml** - 从需求识别的常见模式
- **pattern-categories.csv** - 教导 LLM 需要定义什么的模式原则
- **checklist.md** - 输出文档的验证要求
- **architecture-template.md** - 最终文档的严格格式

---

## 与旧架构工作流程的不同之处

| 方面         | 旧工作流程                | 新工作流程                 |
| ------------ | ------------------------- | -------------------------- |
| **方法**     | 模板驱动                  | 对话驱动                   |
| **项目类型** | 11 种僵化类型，22+ 个文件 | 无限灵活性，智能发现       |
| **用户交互** | 输出部分带"继续？"        | 协作决策促进               |
| **技能适应** | 一刀切                    | 适应初学者/中级/专家       |
| **决策制定** | 流程后期（步骤 5）        | 前期和中心焦点             |
| **输出**     | 多个文档，包括伪技术规格  | 单个以决策为中心的架构     |
| **时间**     | 困惑且缓慢                | 30-90 分钟，取决于技能水平 |
| **启发**     | 从未使用                  | 在决策点集成               |

---

## 预期输入

- **PRD**（产品需求文档）包含：
  - 功能需求
  - 非功能需求
  - 性能和合规需求

- **Epics** 文件包含：
  - 用户故事
  - 验收标准
  - 依赖关系

- **UX 规格**（可选但有价值）包含：
  - 界面设计和交互模式
  - 可访问性需求（WCAG 级别）
  - 动画和过渡需求
  - 平台特定的 UI 需求
  - 交互的性能期望

---

## 输出文档

一个 `architecture.md` 文件包含：

- 执行摘要（2-3 句）
- 项目初始化命令（如果使用起始模板）
- 带有验证版本和史诗映射的决策摘要表
- 完整的项目结构
- 集成规格说明
- AI 代理的一致性规则

---

## 新颖模式设计如何工作

步骤 7 处理需要发明的独特或复杂模式：

### 1. 检测

工作流程分析 PRD 中没有标准解决方案的概念：

- 新颖的交互模式（例如，Tinder 不存在时的"滑动匹配"）
- 复杂的多史诗工作流程（例如，"病毒式邀请系统"）
- 独特的数据关系（例如，Facebook 之前的"社交图谱"）
- 新范式（例如，Snapchat 之前的"临时消息"）

### 2. 设计协作

工作流程帮助设计解决方案，而不仅仅是选择技术：

- 识别要解决的核心问题
- 与用户探索不同的方法
- 记录组件如何交互
- 为复杂流程创建序列图
- 使用启发方法找到创新解决方案

### 3. 文档化

新颖模式成为架构的一部分，包括：

- 模式名称和目的
- 组件交互
- 数据流图
- 受影响的史诗/故事
- 代理的实施指导

### 4. 示例

```
PRD："用户可以创建具有重叠成员资格的朋友'圈子'"
↓
工作流程检测：这是一个新颖的社交结构模式
↓
与用户设计：圈子成员资格模型、权限级联、UI 模式
↓
文档化："圈子模式"及组件设计和数据流
↓
所有代理都理解如何一致地实施圈子相关功能
```

---

## 实施模式如何工作

步骤 8 通过定义一致性模式来防止代理冲突：

### 1. 核心原则

> "任何时候多个代理可能以不同方式做出相同的决策，那就要捕获一个模式"

LLM 询问："代理可能遇到什么他们必须猜测的情况？"

### 2. 模式类别（原则，而不是处方）

- **命名**：事物如何命名（API、数据库字段、文件）
- **结构**：事物如何组织（文件夹、模块、层）
- **格式**：数据如何格式化（JSON 结构、响应）
- **通信**：组件如何交谈（事件、消息、协议）
- **生命周期**：状态如何改变（工作流程、转换）
- **位置**：事物放在哪里（URL、路径、存储）
- **一致性**：横切关注点（日期、错误、日志）

### 3. LLM 智能

- 使用原则识别 7 个类别之外的模式
- 找出对于所选技术重要的特定模式
- 只询问可能导致冲突的模式
- 跳过技术选择决定的明显模式

### 4. 示例

```
选择的技术：REST API + PostgreSQL + React
↓
LLM 识别需求：
- REST：URL 结构、响应格式、状态码
- PostgreSQL：表命名、列命名、FK 模式
- React：组件结构、状态管理、测试位置
↓
与用户促进每个
↓
在架构中记录为实施模式
```

---

## 起始模板如何工作

当工作流程检测到具有起始模板的项目类型时：

1. **发现**：基于 PRD 搜索相关的起始模板
2. **调查**：查找当前 CLI 选项和默认值
3. **呈现**：向用户显示起始提供的内容
4. **集成**：将起始决策记录为"由起始提供"
5. **继续**：只询问起始未做出的决策
6. **文档化**：在架构中包含确切的初始化命令

### 示例流程

```
PRD 说："带认证的 Next.js Web 应用程序"
↓
工作流程找到：create-next-app 和 create-t3-app
↓
用户选择：create-t3-app（包括认证设置）
↓
起始提供：Next.js、TypeScript、tRPC、Prisma、NextAuth、Tailwind
↓
工作流程只询问：数据库选择、部署目标、额外服务
↓
第一个故事变成："npx create t3-app@latest my-app --trpc --nextauth --prisma"
```

---

## 使用方法

```bash
# 在您的 BMAD 启用项目中
workflow architecture
```

AI 代理将：

1. 加载您的 PRD 和史诗
2. 识别所需的关键决策
3. 促进每个决策的讨论
4. 生成全面的架构文档
5. 验证完整性

---

## 设计原则

1. **促进胜过处方** - 指导用户做出好的决策，而不是强加模板
2. **智能胜过模板** - 使用 AI 理解而不是僵化结构
3. **决策胜过细节** - 专注于防止代理冲突，而不是实施细节
4. **适应胜过统一** - 在确保质量输出的同时满足用户需求
5. **协作胜过输出** - 对话与文档同样重要

---

## 对于开发者

此工作流程假设：

- 单个开发者 + AI 代理（不是团队）
- 速度很重要（分钟级决策，不是天级）
- AI 代理需要清晰的约束以防止冲突
- 架构文档是为代理，不是为人类

---

## 从旧架构工作流程迁移

使用旧 `architecture` 工作流程的项目应该：

1. 完成任何进行中的架构工作
2. 对新项目使用 `architecture`
3. 旧工作流程仍然可用但已弃用

---

## 版本历史

**1.3.2** - UX 规格集成和模糊文件匹配

- 添加了 UX 规格作为可选输入，带模糊文件匹配
- 更新了 workflow.yaml 与输入文件引用
- 起始模板选择现在考虑 UX 需求
- 向检查表添加了 UX 对齐验证
- 指令使用变量引用以实现灵活文件名

**1.3.1** - 工作流程细化和标准化

- 在开始添加了工作流程状态检查（步骤 0 和 0.5）
- 在结束添加了工作流程状态更新（步骤 12）
- 为清晰重新组织了步骤编号（移除了小数步骤）
- 在整个过程中增强了基于意图的方法
- 改进了所有工作流程组件的内聚性

**1.3.0** - 独特架构的新颖模式设计

- 添加了新颖模式设计（现在是步骤 7，之前是步骤 5.3）
- 检测 PRD 中需要架构发明的新颖概念
- 促进带序列图的设计协作
- 使用启发方法获得创新方法
- 为多史诗一致性记录自定义模式

**1.2.0** - 代理一致性的实施模式

- 添加了实施模式（现在是步骤 8，之前是步骤 5.5）
- 创建了基于原则的 pattern-categories.csv（7 个原则，不是 118 个处方）
- 核心原则："代理可能有什么不同的决定？"
- LLM 使用原则识别类别之外的模式
- 通过智能模式发现防止代理冲突

**1.1.0** - 增强起始模板发现和版本验证

- 添加了智能起始模板检测和集成（现在是步骤 2）
- 通过网络搜索添加了动态版本验证
- 起始决策记录为"由起始提供"
- 第一个实施故事使用起始初始化命令

**1.0.0** - 初始发布，替换架构工作流程

---

**相关文档：**

- [解决方案设计工作流程](./workflows-solutioning.md)
- [规划工作流程](./workflows-planning.md)
- [规模自适应系统](./scale-adaptive-system.md)
